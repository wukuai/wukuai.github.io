<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>REPLACE操作导致主从库AUTO_INCREMENT不一致的分析 | 五块的博客</title><meta name="description" content="REPLACE操作导致主从库AUTO_INCREMENT不一致的分析"><meta name="author" content="wukuai"><meta name="copyright" content="wukuai"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://avatars2.githubusercontent.com/u/17941566?s=460&v=4"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><meta name="twitter:card" content="summary"><meta name="twitter:title" content="REPLACE操作导致主从库AUTO_INCREMENT不一致的分析"><meta name="twitter:description" content="REPLACE操作导致主从库AUTO_INCREMENT不一致的分析"><meta name="twitter:image" content="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/324EB27B73F4CCFB76DCCD49F8D59DD2.jpg"><meta property="og:type" content="article"><meta property="og:title" content="REPLACE操作导致主从库AUTO_INCREMENT不一致的分析"><meta property="og:url" content="https://yangwuyuan.com/2019/05/10/REPLACE操作导致主从库AUTO-INCREMENT不一致的分析/"><meta property="og:site_name" content="五块的博客"><meta property="og:description" content="REPLACE操作导致主从库AUTO_INCREMENT不一致的分析"><meta property="og:image" content="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/324EB27B73F4CCFB76DCCD49F8D59DD2.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://yangwuyuan.com/2019/05/10/REPLACE操作导致主从库AUTO-INCREMENT不一致的分析/"><link rel="next" title="INSERT ON DUPLICATE KEY UPDATE与 REPLACE 语句简介" href="https://yangwuyuan.com/2018/10/30/INSERT ON DUPLICATE KEY UPDATE与 REPLACE 语句简介/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://yangwuyuan.com","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script></head><body><canvas class="fireworks"></canvas><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">五块的博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-coffee"></i><span> 留言板</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#问题复现"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">问题复现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#REPLACE操作导致AUTO-INCREMENT值不一致"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">REPLACE操作导致AUTO_INCREMENT值不一致</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#从库升主后插入数据报错"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">从库升主后插入数据报错</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#原因分析"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">原因分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#replace操作在binlog-row格式-中的行为分析"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">replace操作在binlog(row格式)中的行为分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#尝试修复："><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">尝试修复：</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#可能的修复方法一："><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">可能的修复方法一：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#可能的修复方法二："><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">可能的修复方法二：</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#mysql8-0实验"><span class="toc_mobile_items-number">4.2.1.</span> <span class="toc_mobile_items-text">mysql8.0实验</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#小结"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">小结</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#附："><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">附：</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#问题复现"><span class="toc-number">1.</span> <span class="toc-text">问题复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#REPLACE操作导致AUTO-INCREMENT值不一致"><span class="toc-number">1.1.</span> <span class="toc-text">REPLACE操作导致AUTO_INCREMENT值不一致</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#从库升主后插入数据报错"><span class="toc-number">1.2.</span> <span class="toc-text">从库升主后插入数据报错</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#原因分析"><span class="toc-number">2.</span> <span class="toc-text">原因分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#replace操作在binlog-row格式-中的行为分析"><span class="toc-number">3.</span> <span class="toc-text">replace操作在binlog(row格式)中的行为分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#尝试修复："><span class="toc-number">4.</span> <span class="toc-text">尝试修复：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#可能的修复方法一："><span class="toc-number">4.1.</span> <span class="toc-text">可能的修复方法一：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#可能的修复方法二："><span class="toc-number">4.2.</span> <span class="toc-text">可能的修复方法二：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql8-0实验"><span class="toc-number">4.2.1.</span> <span class="toc-text">mysql8.0实验</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#附："><span class="toc-number">6.</span> <span class="toc-text">附：</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/324EB27B73F4CCFB76DCCD49F8D59DD2.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">REPLACE操作导致主从库AUTO_INCREMENT不一致的分析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-05-10<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-01-15</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>在某些情况下，replace操作将导致主从库auto_increment值不一致，如果此时发生切换，将可能导致数据无法插入的问题。</p>
<h1 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h1><h2 id="REPLACE操作导致AUTO-INCREMENT值不一致"><a href="#REPLACE操作导致AUTO-INCREMENT值不一致" class="headerlink" title="REPLACE操作导致AUTO_INCREMENT值不一致"></a>REPLACE操作导致AUTO_INCREMENT值不一致</h2><p>测试版本：5.7.23</p>
<p>建表语句：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t1`</span> (</span><br><span class="line"><span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"><span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line"><span class="string">`data`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line"><span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> uniq_name(<span class="keyword">name</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure></div></p>
<p>初始插入一些记录：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(<span class="keyword">name</span>, <span class="keyword">data</span>) <span class="keyword">values</span></span><br><span class="line">(<span class="string">'user1'</span>, <span class="string">'data1'</span>), </span><br><span class="line">(<span class="string">'user2'</span>, <span class="string">'data2'</span>), </span><br><span class="line">(<span class="string">'user3'</span>, <span class="string">'data3'</span>),</span><br><span class="line">(<span class="string">'user4'</span>, <span class="string">'data4'</span>),</span><br><span class="line">(<span class="string">'user5'</span>, <span class="string">'data5'</span>);</span><br></pre></td></tr></table></figure></div></p>
<p>查看主从库auto_increment：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/A46B12CD56AE4C1DEF9BF726339F7DDD.jpg" data-fancybox="group" data-caption class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/A46B12CD56AE4C1DEF9BF726339F7DDD.jpg" alt title></a></p>
<p>可以看见此时主从库的auto_increment一致。</p>
<p>使用replace into语句替换部分数据：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">replace</span> <span class="keyword">into</span> t1(<span class="keyword">name</span>, <span class="keyword">data</span>) <span class="keyword">values</span></span><br><span class="line">(<span class="string">'user2'</span>, <span class="string">'new data2'</span>), </span><br><span class="line">(<span class="string">'user3'</span>, <span class="string">'new data3'</span>), </span><br><span class="line">(<span class="string">'user4'</span>, <span class="string">'new data4'</span>);</span><br></pre></td></tr></table></figure></div></p>
<p>再次查看主从库表中数据与auto_increment值：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/A03B75B1BB7795A51D963D2EB13F6729.jpg" data-fancybox="group" data-caption class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/A03B75B1BB7795A51D963D2EB13F6729.jpg" alt title></a><br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/E789D01185EC20223569A8A8EF4948A1.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/E789D01185EC20223569A8A8EF4948A1.jpg" alt="IMAGE" title="IMAGE"></a><br>发现此时主备库auto_increment不一致。</p>
<h2 id="从库升主后插入数据报错"><a href="#从库升主后插入数据报错" class="headerlink" title="从库升主后插入数据报错"></a>从库升主后插入数据报错</h2><p>如果这时发生主从切换，即在原从库尝试插入数据：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(<span class="keyword">name</span>, <span class="keyword">data</span>) <span class="keyword">values</span>(<span class="string">'user6'</span>, <span class="string">'data6'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(<span class="keyword">name</span>, <span class="keyword">data</span>) <span class="keyword">values</span>(<span class="string">'user7'</span>, <span class="string">'data7'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(<span class="keyword">name</span>, <span class="keyword">data</span>) <span class="keyword">values</span>(<span class="string">'user8'</span>, <span class="string">'data8'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(<span class="keyword">name</span>, <span class="keyword">data</span>) <span class="keyword">values</span>(<span class="string">'user9'</span>, <span class="string">'data9'</span>);</span><br></pre></td></tr></table></figure></div></p>
<p><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/324EB27B73F4CCFB76DCCD49F8D59DD2.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/324EB27B73F4CCFB76DCCD49F8D59DD2.jpg" alt="IMAGE" title="IMAGE"></a></p>
<p>原备库的auto_increment值为6，由于之前的replace操作，表中数据已经存在主键id为6, 7, 8的记录，导致前三条语句插入失败，报错重复主键。</p>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>尝试分析导致主备库auto_increment不一致的原因：<br>查看主库记录的binlog(row格式)，发现上述replace操作在binlog中记录的是update操作：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">### UPDATE `test`.`t1`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2='user2' /* VARSTRING(10) meta=10 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='data2' /* VARSTRING(100) meta=100 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=6 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2='user2' /* VARSTRING(10) meta=10 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='new data2' /* VARSTRING(100) meta=100 nullable=0 is_null=0 */</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<p>从库应用以上日志时，只更新了自增列的值（大于auto_increment），而auto_increment值并未增加，如果此时发生切换，向原从库insert数据，就会报错。</p>
<h1 id="replace操作在binlog-row格式-中的行为分析"><a href="#replace操作在binlog-row格式-中的行为分析" class="headerlink" title="replace操作在binlog(row格式)中的行为分析"></a>replace操作在binlog(row格式)中的行为分析</h1><p>在<a href="https://dev.mysql.com/doc/refman/5.7/en/replace.html" target="_blank" rel="noopener">官方文档</a>中replace的语义有这样一句话：”It either inserts, or deletes and inserts.”，<br>然而通过上面的实验可看出replace操作在row格式下的binlog中记录的并不是delete+insert操作，而是直接update。<br>那么是不是所有情况都是记录的update操作呢，可以实验观察：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t2`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`a`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`b`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`c`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_a`</span> (<span class="string">`a`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_b`</span> (<span class="string">`b`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_c`</span> (<span class="string">`c`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span></span><br></pre></td></tr></table></figure></div></p>
<p>通过先insert数据，再执行replace操作，并观察不同的冲突情况及row格式下的binlog中记录的行为，整理如下表，其中*表示与哪一个键冲突，同一颜色跨越多行的表示replace操作和多行记录都有冲突（<a href="http://cooper.didichuxing.com/shares/G273ECAtUQpH" target="_blank" rel="noopener">实验重现与原始数据</a>）：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/06FC90BB7DD38573BC900899E8C77A03.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/06FC90BB7DD38573BC900899E8C77A03.jpg" alt="IMAGE" title="IMAGE"></a></p>
<p>可以看见replace操作发生冲突时在binlog中记录的行为并不一致，既有(delete+)update的情况，也有delete+insert的情况。其中记录为update操作的在图中用红色字体标注，可以发现它们都有一个共同点就是在一行内仅有唯一键c冲突。</p>
<p>同时，不同的表结构还未测试：例如含有联合唯一键的表结构、仅存在主键的表结构、仅含有主键和其它非唯一键的表结构、含有主键+唯一键+非唯一键的表结构等等。</p>
<p>那么mysql是如何判断replace操作在binlog中记录的类型呢：<br>带着问题翻看源码，可以看见在sql_insert.cc和log_event.cc中有相关代码：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">sql_insert.cc:</span><br><span class="line">...</span><br><span class="line"><span class="comment">/* Check if there is more uniq keys after field */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">last_uniq_key</span><span class="params">(TABLE *table,uint keynr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    When an underlying storage engine informs that the unique key</span></span><br><span class="line"><span class="comment">    conflicts are not reported in the ascending order by setting</span></span><br><span class="line"><span class="comment">    the HA_DUPLICATE_KEY_NOT_IN_ORDER flag, we cannot rely on this</span></span><br><span class="line"><span class="comment">    information to determine the last key conflict.</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">    The information about the last key conflict will be used to</span></span><br><span class="line"><span class="comment">    do a replace of the new row on the conflicting row, rather</span></span><br><span class="line"><span class="comment">    than doing a delete (of old row) + insert (of new row).</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">    Hence check for this flag and disable replacing the last row</span></span><br><span class="line"><span class="comment">    by returning 0 always. Returning 0 will result in doing</span></span><br><span class="line"><span class="comment">    a delete + insert always.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (table-&gt;file-&gt;ha_table_flags() &amp; HA_DUPLICATE_KEY_NOT_IN_ORDER)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (++keynr &lt; table-&gt;s-&gt;keys)&#123;</span><br><span class="line">    <span class="keyword">if</span> (table-&gt;key_info[keynr].flags &amp; HA_NOSAME)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	  The manual defines the REPLACE semantics that it is either</span></span><br><span class="line"><span class="comment">	  an INSERT or DELETE(s) + INSERT; FOREIGN KEY checks in</span></span><br><span class="line"><span class="comment">	  InnoDB do not function in the defined way if we allow MySQL</span></span><br><span class="line"><span class="comment">	  to convert the latter operation internally to an UPDATE.</span></span><br><span class="line"><span class="comment">          We also should not perform this conversion if we have </span></span><br><span class="line"><span class="comment">          timestamp field with ON UPDATE which is different from DEFAULT.</span></span><br><span class="line"><span class="comment">          Another case when conversion should not be performed is when</span></span><br><span class="line"><span class="comment">          we have ON DELETE trigger on table so user may notice that</span></span><br><span class="line"><span class="comment">          we cheat here. Note that it is ok to do such conversion for</span></span><br><span class="line"><span class="comment">          tables which have ON UPDATE but have no ON DELETE triggers,</span></span><br><span class="line"><span class="comment">          we just should not expose this fact to users by invoking</span></span><br><span class="line"><span class="comment">          ON UPDATE triggers.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">if</span> (last_uniq_key(table,key_nr) &amp;&amp;</span><br><span class="line">	    !table-&gt;file-&gt;referenced_by_foreign_key() &amp;&amp;</span><br><span class="line">            (!table-&gt;triggers || !table-&gt;triggers-&gt;has_delete_triggers()))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ((error=table-&gt;file-&gt;ha_update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line">					        table-&gt;record[<span class="number">0</span>])) &amp;&amp;</span><br><span class="line">              error != HA_ERR_RECORD_IS_THE_SAME)</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">          <span class="keyword">if</span> (error != HA_ERR_RECORD_IS_THE_SAME)</span><br><span class="line">            info-&gt;stats.deleted++;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            error= <span class="number">0</span>;</span><br><span class="line">          thd-&gt;record_first_successful_insert_id_in_cur_stmt(table-&gt;file-&gt;insert_id_for_cur_row);</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Since we pretend that we have done insert we should call</span></span><br><span class="line"><span class="comment">            its after triggers.</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">          <span class="keyword">goto</span> after_trg_n_copied_inc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<p>在log_event.cc中也有上述相近代码，但在调试过程中发现并未调用，所以以上述代码为准初步分析：</p>
<p>可以看见mysql选择将replace操作转换为update操作的条件为：<br>当发生冲突的键是最后一个唯一键 且 没有外键引用 且 没有触发器</p>
<p>由于我们线上不使用外键和触发器，所以暂不关心后两个条件。</p>
<p>这也验证了上述实验的数据：由于t1表中name是最后一个唯一键，t2表中c是最后一个唯一键，所以当最后一个唯一键冲突时，在binlog中记录的是update操作，其它情况记录的则是delete+insert操作。</p>
<h1 id="尝试修复："><a href="#尝试修复：" class="headerlink" title="尝试修复："></a>尝试修复：</h1><p>腾讯数据库技术公众号在2018年12月的<a href="https://mp.weixin.qq.com/s/YjPOayOFwCPwH084SG2Ggw" target="_blank" rel="noopener">一篇文章</a>中提到了相同问题，给出了如下修复方案：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/08E685012BDE7457A3495C16DCAA6B88.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/08E685012BDE7457A3495C16DCAA6B88.jpg" alt="IMAGE" title="IMAGE"></a><br>这里主要在内核侧对第2种修复方法进行了实现，尝试对源码进行修改：<br>sql_insert.cc中的last_uniq_key()函数只在上述一处被调用，且无外部文件调用。<br>至于为什么程序会判断last_uniq_key()只能在log_event.cc中找到如下一段相关的注释：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">I (Matz) am not sure of the reason for the last_uniq_key()</span><br><span class="line">check as, but I&apos;m guessing that it&apos;s something along the</span><br><span class="line">following lines.</span><br><span class="line"></span><br><span class="line">Suppose that we got the duplicate key to be a key that is not</span><br><span class="line">the last unique key for the table and we perform an update:</span><br><span class="line">then there might be another key for which the unique check will</span><br><span class="line">fail, so we&apos;re better off just deleting the row and inserting</span><br><span class="line">the correct row.</span><br></pre></td></tr></table></figure></div></p>
<p>last_uniq_key()函数是mysql在repacle操作遇到冲突时采取 delete+insert 或是 update 行为的关键，下面是该函数的历史变更记录：<br>sql_insert.cc中和last_uniq_key()相关的历史变更记录摘要如下，内容较多预警，已经尽量省略，<a href="http://cooper.didichuxing.com/shares/FwNSdycjsB2U" target="_blank" rel="noopener">更详细的的记录可以点此</a>：</p>
<p>在2000年mysql的第一次提交记录中就引入了last_uniq_key()函数，此时的条件判断相当简单，只有last_uniq_key()一个条件：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">commit f4c589ff6c653d1d2a09c26e46ead3c8a15655d8</span><br><span class="line">Author: bk@work.mysql.com &lt;&gt;</span><br><span class="line">Date:   Mon Jul <span class="number">31</span> <span class="number">21</span>:<span class="number">29</span>:<span class="number">14</span> <span class="number">2000</span> +<span class="number">0200</span></span><br><span class="line">...</span><br><span class="line">+<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">last_uniq_key</span><span class="params">(TABLE *table,uint keynr)</span></span></span><br><span class="line">+&#123;</span><br><span class="line">+  <span class="keyword">while</span> (++keynr &lt; table-&gt;keys)</span><br><span class="line">+    <span class="keyword">if</span> (table-&gt;key_info[keynr].flags &amp; HA_NOSAME)</span><br><span class="line">+      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">+&#125;</span><br><span class="line">...</span><br><span class="line">+      <span class="keyword">if</span> (last_uniq_key(table,key_nr))</span><br><span class="line">+      &#123;</span><br><span class="line">+	<span class="keyword">if</span> ((error=table-&gt;file-&gt;update_row(table-&gt;record[<span class="number">1</span>],table-&gt;record[<span class="number">0</span>])))</span><br><span class="line">+	  <span class="keyword">goto</span> err;</span><br><span class="line">+	info-&gt;deleted++;</span><br><span class="line">+	<span class="keyword">break</span>;					<span class="comment">/* Update logfile and count */</span></span><br><span class="line">+      &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<p>repalce在内部实现的update行为会导致有外键引用的表出现问题，这里又加入了一个例外条件：table-&gt;file-&gt;referenced_by_foreign_key()<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">commit d9790a406c69a46eb197cea725c1e7c7e480ac41</span><br><span class="line">Author: heikki@hundin.mysql.fi &lt;&gt;</span><br><span class="line">Date:   Mon Feb <span class="number">9</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">29</span> <span class="number">2004</span> +<span class="number">0200</span></span><br><span class="line">    Many files:</span><br><span class="line">      Do not let REPLACE to perform internally an UPDATE if the table is referenced by a FOREIGN KEY: the manual says that REPLACE must resolve a duplicate key error semantically with DELETE(s) + INSERT, and not by an UPDATE; the internal update caused foreign key checks and cascaded operations to behave in a semantically wrong way</span><br><span class="line">...</span><br><span class="line">-      <span class="keyword">if</span> (last_uniq_key(table,key_nr))</span><br><span class="line">+      <span class="comment">/*</span></span><br><span class="line"><span class="comment">+	The manual defines the REPLACE semantics that it is either an INSERT or</span></span><br><span class="line"><span class="comment">+	DELETE(s) + INSERT; FOREIGN KEY checks do not function in the defined</span></span><br><span class="line"><span class="comment">+	way if we allow MySQL to convert the latter operation internally to an</span></span><br><span class="line"><span class="comment">+	UPDATE.</span></span><br><span class="line"><span class="comment">+      */</span></span><br><span class="line">+</span><br><span class="line">+      <span class="keyword">if</span> (last_uniq_key(table,key_nr)</span><br><span class="line">+	  &amp;&amp; !table-&gt;file-&gt;referenced_by_foreign_key())</span><br><span class="line">       &#123;</span><br><span class="line"> 	<span class="keyword">if</span> ((error=table-&gt;file-&gt;update_row(table-&gt;record[<span class="number">1</span>],table-&gt;record[<span class="number">0</span>])))</span><br><span class="line"> 	  <span class="keyword">goto</span> err;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<p>后续又不断加入了多个条件，例如：table-&gt;timestamp_default_now == table-&gt;timestamp_on_update_now、 (!table-&gt;triggers || !table-&gt;triggers-&gt;has_delete_triggers())) 等等：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">commit f6bff2e6c662d4778f86a919b6f7b731d2553f44</span><br><span class="line">Author: dlenev@jabberwock.localdomain &lt;&gt;</span><br><span class="line">Date:   Fri Apr <span class="number">2</span> <span class="number">10</span>:<span class="number">12</span>:<span class="number">53</span> <span class="number">2004</span> +<span class="number">0400</span></span><br><span class="line"></span><br><span class="line">    WL#<span class="number">1266</span> <span class="string">"Separate auto-set logic from TIMESTAMP type."</span></span><br><span class="line">    </span><br><span class="line">    Final version of patch.</span><br><span class="line">    </span><br><span class="line">    Adds support for specifying of DEFAULT NOW() and/or ON UPDATE NOW()</span><br><span class="line">    clauses <span class="keyword">for</span> TIMESTAMP field definition.</span><br><span class="line">    Current implementation allows only one such field per table <span class="keyword">and</span></span><br><span class="line">    uses several unireg types <span class="keyword">for</span> storing info about <span class="keyword">this</span> properties of</span><br><span class="line">    field. It should be replaced with better implementation when <span class="keyword">new</span></span><br><span class="line">    .frm format is introduced.</span><br><span class="line">...</span><br><span class="line"> 	  an INSERT <span class="keyword">or</span> DELETE(s) + INSERT; FOREIGN KEY checks in</span><br><span class="line"> 	  InnoDB <span class="keyword">do</span> <span class="keyword">not</span> function in the defined way <span class="keyword">if</span> we allow MySQL</span><br><span class="line"> 	  to convert the latter operation internally to an UPDATE.</span><br><span class="line">+          We also should <span class="keyword">not</span> perform <span class="keyword">this</span> conversion <span class="keyword">if</span> we have </span><br><span class="line">+          timestamp field with ON UPDATE which is different from DEFAULT.</span><br><span class="line"> 	*/</span><br><span class="line"> 	<span class="keyword">if</span> (last_uniq_key(table,key_nr) &amp;&amp;</span><br><span class="line">-	    !table-&gt;file-&gt;referenced_by_foreign_key())</span><br><span class="line">+	    !table-&gt;file-&gt;referenced_by_foreign_key() &amp;&amp;</span><br><span class="line">+            table-&gt;timestamp_default_now == table-&gt;timestamp_on_update_now)</span><br><span class="line">         &#123;</span><br><span class="line">           <span class="keyword">if</span> ((error=table-&gt;file-&gt;update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line"> 					     table-&gt;record[<span class="number">0</span>])))</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="number">2511990</span>c978137fe0bc81657e160a6d537bc957f</span><br><span class="line">Author: dlenev@brandersnatch.localdomain &lt;&gt;</span><br><span class="line">Date:   Fri Oct <span class="number">1</span> <span class="number">18</span>:<span class="number">54</span>:<span class="number">06</span> <span class="number">2004</span> +<span class="number">0400</span></span><br><span class="line"></span><br><span class="line">    Support <span class="keyword">for</span> TIMESTAMP columns holding <span class="literal">NULL</span> values. Unlike all other</span><br><span class="line">    column types TIMESTAMP is NOT <span class="literal">NULL</span> by <span class="keyword">default</span>, so in order to have</span><br><span class="line">    TIMESTAMP column holding <span class="literal">NULL</span> valaues you have to specify <span class="literal">NULL</span> as</span><br><span class="line">    one of its attributes (this needed for backward compatibility).</span><br><span class="line">    </span><br><span class="line">    Main changes:</span><br><span class="line">    Replaced TABLE::timestamp_default_now/on_update_now members with</span><br><span class="line">    TABLE::timestamp_auto_set_type flag which is used everywhere</span><br><span class="line">    <span class="keyword">for</span> determining <span class="keyword">if</span> we should <span class="keyword">auto</span>-<span class="built_in">set</span> value of TIMESTAMP field</span><br><span class="line">    during <span class="keyword">this</span> operation <span class="keyword">or</span> <span class="keyword">not</span>. We are also use Field_timestamp::set_time()</span><br><span class="line">    instead of handler::update_timestamp() in handlers.</span><br><span class="line">...</span><br><span class="line"> 	<span class="keyword">if</span> (last_uniq_key(table,key_nr) &amp;&amp;</span><br><span class="line"> 	    !table-&gt;file-&gt;referenced_by_foreign_key() &amp;&amp;</span><br><span class="line">-            table-&gt;timestamp_default_now == table-&gt;timestamp_on_update_now)</span><br><span class="line">+            (table-&gt;timestamp_field_type == TIMESTAMP_NO_AUTO_SET ||</span><br><span class="line">+             table-&gt;timestamp_field_type == TIMESTAMP_AUTO_SET_ON_BOTH))</span><br><span class="line">         &#123;</span><br><span class="line">           <span class="keyword">if</span> ((error=table-&gt;file-&gt;update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line"> 					     table-&gt;record[<span class="number">0</span>])))</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="number">007</span>a20591892beb3734ed4d29fdfe28b750f435a</span><br><span class="line">Author: dlenev@brandersnatch.localdomain &lt;&gt;</span><br><span class="line">Date:   Tue May <span class="number">24</span> <span class="number">22</span>:<span class="number">19</span>:<span class="number">33</span> <span class="number">2005</span> +<span class="number">0400</span></span><br><span class="line"></span><br><span class="line">    Fix <span class="keyword">for</span> bugs:</span><br><span class="line">     #<span class="number">5860</span> <span class="string">"Multi-table UPDATE does not activate update triggers"</span></span><br><span class="line">     #<span class="number">6812</span> <span class="string">"Triggers are not activated for INSERT ... SELECT"</span></span><br><span class="line">     #<span class="number">8755</span> <span class="string">"Trigger is not activated by LOAD DATA"</span>.</span><br><span class="line">    This patch also implements proper handling of triggers <span class="keyword">for</span> special forms</span><br><span class="line">    of insert like REPLACE <span class="keyword">or</span> INSERT ... ON DUPLICATE KEY UPDATE.</span><br><span class="line">    Also now we don't call after trigger in <span class="keyword">case</span> when we have failed to</span><br><span class="line">    inserted/update <span class="keyword">or</span> <span class="keyword">delete</span> row. Trigger failure should stop statement</span><br><span class="line">    execution.</span><br><span class="line">    </span><br><span class="line">    I have <span class="keyword">not</span> properly tested handling of errors which happen inside of</span><br><span class="line">    triggers in <span class="keyword">this</span> patch, since it is simplier to <span class="keyword">do</span> <span class="keyword">this</span> once we will be</span><br><span class="line">    able to access tables from triggers.</span><br><span class="line">...</span><br><span class="line">             (table-&gt;timestamp_field_type == TIMESTAMP_NO_AUTO_SET ||</span><br><span class="line">              table-&gt;timestamp_field_type == TIMESTAMP_AUTO_SET_ON_BOTH))</span><br><span class="line">         &#123;</span><br><span class="line">+          <span class="keyword">if</span> (table-&gt;triggers &amp;&amp;</span><br><span class="line">+              table-&gt;triggers-&gt;process_triggers(thd, TRG_EVENT_UPDATE,</span><br><span class="line">+                                                TRG_ACTION_BEFORE, TRUE))</span><br><span class="line">+            <span class="keyword">goto</span> before_trg_err;</span><br><span class="line">           <span class="keyword">if</span> ((error=table-&gt;file-&gt;update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line"> 					     table-&gt;record[<span class="number">0</span>])))</span><br><span class="line">             <span class="keyword">goto</span> err;</span><br><span class="line">           info-&gt;deleted++;</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="number">59</span>d20e26d57e9fc33cf44ada4ce511f507e3d623</span><br><span class="line">Author: dlenev@mysql.com &lt;&gt;</span><br><span class="line">Date:   Fri Jun <span class="number">16</span> <span class="number">20</span>:<span class="number">21</span>:<span class="number">25</span> <span class="number">2006</span> +<span class="number">0400</span></span><br><span class="line"></span><br><span class="line">    Fix <span class="keyword">for</span> bug#<span class="number">13479</span> <span class="string">"REPLACE activates UPDATE trigger, not the DELETE and</span></span><br><span class="line"><span class="string">    INSERT triggers"</span>.</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line"> 	*/</span><br><span class="line"> 	<span class="keyword">if</span> (last_uniq_key(table,key_nr) &amp;&amp;</span><br><span class="line"> 	    !table-&gt;file-&gt;referenced_by_foreign_key() &amp;&amp;</span><br><span class="line">             (table-&gt;timestamp_field_type == TIMESTAMP_NO_AUTO_SET ||</span><br><span class="line">-             table-&gt;timestamp_field_type == TIMESTAMP_AUTO_SET_ON_BOTH))</span><br><span class="line">+             table-&gt;timestamp_field_type == TIMESTAMP_AUTO_SET_ON_BOTH) &amp;&amp;</span><br><span class="line">+            (!table-&gt;triggers || !table-&gt;triggers-&gt;has_delete_triggers()))</span><br><span class="line">         &#123;</span><br><span class="line">-          <span class="keyword">if</span> (table-&gt;triggers &amp;&amp;</span><br><span class="line">-              table-&gt;triggers-&gt;process_triggers(thd, TRG_EVENT_UPDATE,</span><br><span class="line">-                                                TRG_ACTION_BEFORE, TRUE))</span><br><span class="line">-            <span class="keyword">goto</span> before_trg_err;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="number">6</span>eee956d7538410f5fd5ee0f8216b2d89937950a</span><br><span class="line">Author: V Narayanan &lt;v.narayanan@sun.com&gt;</span><br><span class="line">Date:   Thu Dec <span class="number">3</span> <span class="number">16</span>:<span class="number">48</span>:<span class="number">02</span> <span class="number">2009</span> +<span class="number">0530</span></span><br><span class="line"></span><br><span class="line">    WL#<span class="number">4454</span> change sql_insert.cc::last_uniq_key to match keys in any order</span><br><span class="line">    </span><br><span class="line">    Introduce a flag that will enable the REPLACE</span><br><span class="line">    command to work correctly with an underlying</span><br><span class="line">    storage engine that does <span class="keyword">not</span> report unique key</span><br><span class="line">    conflicts in the ascending order.</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">last_uniq_key</span><span class="params">(TABLE *table,uint keynr)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">+  <span class="comment">/*</span></span><br><span class="line"><span class="comment">+    When an underlying storage engine informs that the unique key</span></span><br><span class="line"><span class="comment">+    conflicts are not reported in the ascending order by setting</span></span><br><span class="line"><span class="comment">+    the HA_DUPLICATE_KEY_NOT_IN_ORDER flag, we cannot rely on this</span></span><br><span class="line"><span class="comment">+    information to determine the last key conflict.</span></span><br><span class="line"><span class="comment">+   </span></span><br><span class="line"><span class="comment">+    The information about the last key conflict will be used to</span></span><br><span class="line"><span class="comment">+    do a replace of the new row on the conflicting row, rather</span></span><br><span class="line"><span class="comment">+    than doing a delete (of old row) + insert (of new row).</span></span><br><span class="line"><span class="comment">+   </span></span><br><span class="line"><span class="comment">+    Hence check for this flag and disable replacing the last row</span></span><br><span class="line"><span class="comment">+    by returning 0 always. Returning 0 will result in doing</span></span><br><span class="line"><span class="comment">+    a delete + insert always.</span></span><br><span class="line"><span class="comment">+  */</span></span><br><span class="line">+  <span class="keyword">if</span> (table-&gt;file-&gt;ha_table_flags() &amp; HA_DUPLICATE_KEY_NOT_IN_ORDER)</span><br><span class="line">+    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">+</span><br><span class="line">   <span class="keyword">while</span> (++keynr &lt; table-&gt;s-&gt;keys)</span><br><span class="line">     <span class="keyword">if</span> (table-&gt;key_info[keynr].flags &amp; HA_NOSAME)</span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="number">0</span>d466406d7e33e6c497e91f2865ce3d32cae916f</span><br><span class="line">Author: Martin Hansson &lt;martin.hansson@oracle.com&gt;</span><br><span class="line">Date:   Tue Jan <span class="number">31</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">16</span> <span class="number">2012</span> +<span class="number">0100</span></span><br><span class="line"></span><br><span class="line">    WL#<span class="number">5874</span>: CURRENT_TIMESTAMP as DEFAULT <span class="keyword">for</span> DATETIME columns.</span><br><span class="line">...</span><br><span class="line"> 	<span class="keyword">if</span> (last_uniq_key(table,key_nr) &amp;&amp;</span><br><span class="line"> 	    !table-&gt;file-&gt;referenced_by_foreign_key() &amp;&amp;</span><br><span class="line">-            (table-&gt;timestamp_field_type == TIMESTAMP_NO_AUTO_SET ||</span><br><span class="line">-             table-&gt;timestamp_field_type == TIMESTAMP_AUTO_SET_ON_BOTH) &amp;&amp;</span><br><span class="line">             (!table-&gt;triggers || !table-&gt;triggers-&gt;has_delete_triggers()))</span><br><span class="line">         &#123;</span><br><span class="line">           <span class="keyword">if</span> ((error=table-&gt;file-&gt;ha_update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>
<p>从sql_insert.cc中关于last_uniq_key()的相关变更记录中可以看到在2000年的最初版本中即出现了如果last_uniq_key()则update的逻辑，但是作者并未说明这样做的意图，前文所述log_event.cc中的那段相关注释(“I (Matz) am not sure of the reason for the last_uniq_key() check as…”)第一次出现是在2005年的一次commit:<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">commit ad126d90e019f223470e73e1b2b528f9007c4532</span><br><span class="line">Author: lars@mysql.com &lt;&gt;</span><br><span class="line">Date:   Thu Dec <span class="number">22</span> <span class="number">06</span>:<span class="number">39</span>:<span class="number">02</span> <span class="number">2005</span> +<span class="number">0100</span></span><br><span class="line"></span><br><span class="line">    WL#<span class="number">1012</span>: All changes as one single changeset.</span><br><span class="line">    This includes both code <span class="keyword">and</span> test cases.</span><br><span class="line">...</span><br><span class="line">+</span><br><span class="line">+       REPLACE is defined as either INSERT <span class="keyword">or</span> DELETE + INSERT.  If</span><br><span class="line">+       possible, we can replace it with an UPDATE, but that will <span class="keyword">not</span></span><br><span class="line">+       work on InnoDB <span class="keyword">if</span> FOREIGN KEY checks are necessary.</span><br><span class="line">+</span><br><span class="line">+       I (Matz) <span class="function">am <span class="keyword">not</span> sure of the reason <span class="keyword">for</span> the <span class="title">last_uniq_key</span><span class="params">()</span></span></span><br><span class="line">+       check as, but I'm guessing that it's something along the</span><br><span class="line">+       following lines.</span><br><span class="line">+</span><br><span class="line">+       Suppose that we got the duplicate key to be a key that is <span class="keyword">not</span></span><br><span class="line">+       the last unique key <span class="keyword">for</span> the table <span class="keyword">and</span> we perform an update:</span><br><span class="line">+       then there might be another key <span class="keyword">for</span> which the unique check will</span><br><span class="line">+       fail, so we're better off just deleting the row <span class="keyword">and</span> inserting</span><br><span class="line">+       the correct row.</span><br><span class="line">+     */</span><br><span class="line">+    <span class="keyword">if</span> (last_uniq_key(table, keynum) &amp;&amp;</span><br><span class="line">+        !table-&gt;file-&gt;referenced_by_foreign_key())</span><br><span class="line">+    &#123;</span><br><span class="line">+      error=table-&gt;file-&gt;ha_update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line">+                                       table-&gt;record[<span class="number">0</span>]);</span><br><span class="line">+      <span class="keyword">return</span> error;</span><br><span class="line">+    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<h2 id="可能的修复方法一："><a href="#可能的修复方法一：" class="headerlink" title="可能的修复方法一："></a>可能的修复方法一：</h2><p>了解了last_uniq_key()相关的历史变更，尝试将该逻辑判断去掉，统一replace的内部实现逻辑为(delete+)insert，还能避免诸多关于AUTO_INCREMENT、UPDATE CURRENT_TIMESTAMP、TRIGGER等相关的判断甚至是bug（从提交历史可以看出来）。去掉该处逻辑是否有其它影响还有待讨论，可能的修复方法如下：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">cpp</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-       <span class="keyword">if</span> (last_uniq_key(table,key_nr) &amp;&amp;</span><br><span class="line">-           !table-&gt;file-&gt;referenced_by_foreign_key() &amp;&amp;</span><br><span class="line">-            (!table-&gt;triggers || !table-&gt;triggers-&gt;has_delete_triggers()))</span><br><span class="line">-        &#123;</span><br><span class="line">-          <span class="keyword">if</span> ((error=table-&gt;file-&gt;ha_update_row(table-&gt;record[<span class="number">1</span>],</span><br><span class="line">-                                               table-&gt;record[<span class="number">0</span>])) &amp;&amp;</span><br><span class="line">-              error != HA_ERR_RECORD_IS_THE_SAME)</span><br><span class="line">-            <span class="keyword">goto</span> err;</span><br><span class="line">-          <span class="keyword">if</span> (error != HA_ERR_RECORD_IS_THE_SAME)</span><br><span class="line">-            info-&gt;stats.deleted++;</span><br><span class="line">-          <span class="keyword">else</span></span><br><span class="line">-            error= <span class="number">0</span>;</span><br><span class="line">-          thd-&gt;record_first_successful_insert_id_in_cur_stmt(table-&gt;file-&gt;insert_id_for_cur_row);</span><br><span class="line">-          <span class="comment">/*</span></span><br><span class="line"><span class="comment">-            Since we pretend that we have done insert we should call</span></span><br><span class="line"><span class="comment">-            its after triggers.</span></span><br><span class="line"><span class="comment">-          */</span></span><br><span class="line">-          <span class="keyword">goto</span> after_trg_n_copied_inc;</span><br><span class="line">-        &#125;</span><br><span class="line">-        <span class="keyword">else</span></span><br></pre></td></tr></table></figure></div></p>
<p>如此统一replace操作的内部实现逻辑，通过了含有replace into语句的测试用例（1 skipped），更详细的测试还依赖于完善的测试环境。：</p>
<p>./mtr auto_increment bug39022 bulk_replace debug_sync2 explain flush flush_read_lock func_group grant2 grant_explain_non_select heap heap_btree heap_hash innodb_mysql_lock2 insert insert_notembedded insert_select insert_update join loaddata lock_multi lock_sync merge myisam opt_hints packet parser partition partition_charset partition_explicit_prune partition_locking replace trigger trigger_wl6030 type_timestamp union view</p>
<p><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/F405F2320B1E3FA2D6EC0CDE2C9034D8.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/F405F2320B1E3FA2D6EC0CDE2C9034D8.jpg" alt="IMAGE" title="IMAGE"></a></p>
<h2 id="可能的修复方法二："><a href="#可能的修复方法二：" class="headerlink" title="可能的修复方法二："></a>可能的修复方法二：</h2><p>在mysql8.0版本中不仅将AUTO_INCREMENT值做了持久化，且在做更新操作时，如果表上的自增列被更新为比auto_increment更大的值，auto_increment值也将被更新。<br>实验验证如下：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t1`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`a`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(a) <span class="keyword">values</span>(<span class="number">1</span>), (<span class="number">2</span>), (<span class="number">3</span>);</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">id a</span><br><span class="line">1 1</span><br><span class="line">2 2</span><br><span class="line">3 3</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1\G</span><br></pre></td></tr></table></figure></div></p>
<p><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/DA85B82B48AF8AD124259EBBF9C803C6.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/DA85B82B48AF8AD124259EBBF9C803C6.jpg" alt="IMAGE" title="IMAGE"></a><br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> <span class="keyword">id</span> = <span class="number">6</span> <span class="keyword">where</span> <span class="keyword">id</span> =<span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">id a</span><br><span class="line">2 2</span><br><span class="line">3 3</span><br><span class="line">6 1</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1\G</span><br></pre></td></tr></table></figure></div></p>
<p>mysql8.0.13表现如下：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/D63F8B0EA408EEC507DFEC6A04646110.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/D63F8B0EA408EEC507DFEC6A04646110.jpg" alt="IMAGE" title="IMAGE"></a></p>
<p>而mysql5.7.23不会因为上诉UPDATE操作更新auto_increment值：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/AD4BC094A1A65B4164474F7D8DD85D3D.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/AD4BC094A1A65B4164474F7D8DD85D3D.jpg" alt="IMAGE" title="IMAGE"></a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(a) <span class="keyword">values</span>(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(a) <span class="keyword">values</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1(a) <span class="keyword">values</span>(<span class="number">6</span>);</span><br><span class="line">mysql8.0.13表现如下：</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">id a</span><br><span class="line">2 2</span><br><span class="line">3 3</span><br><span class="line">6 1</span><br><span class="line">7 4</span><br><span class="line">8 5</span><br><span class="line">9 6</span><br><span class="line">mysql5.7.23表现如下：</span><br><span class="line">ERROR 1062 (23000): Duplicate entry '6' for key 'PRIMARY'</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">id a</span><br><span class="line">2 2</span><br><span class="line">3 3</span><br><span class="line">4 4</span><br><span class="line">5 5</span><br><span class="line">6 1</span><br></pre></td></tr></table></figure></div>
<p>可以看见两者之间的差异，在myql8.0中UPDATE操作如果将自增列的值更新为比auto_increment大，auto_increment的值也会发生更新。</p>
<p>在文中开头提到的主从复制场景中，如果replace操作当最后一个唯一键索引冲突的情况下在row格式的binlog中记录为update操作，从库在应用日志时也会更新auto_increment值。如此在发生切换时就不会发生原从库的自增列的最大值大于当前auto_increment值而导致数据无法插入的情况了。</p>
<h3 id="mysql8-0实验"><a href="#mysql8-0实验" class="headerlink" title="mysql8.0实验"></a>mysql8.0实验</h3><p>使用mysql8.0.13重现文中一开头提到的实验：<br>row格式的binlog中记录的是UPDATE操作：<br><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">### UPDATE `test`.`t1`</span><br><span class="line">### WHERE</span><br><span class="line">###   @1=3 /* INT meta=0 nullable=0 is_null=0 */</span><br><span class="line">###   @2=&apos;user3&apos; /* VARSTRING(40) meta=40 nullable=0 is_null=0 */</span><br><span class="line">###   @3=&apos;data3&apos; /* VARSTRING(400) meta=400 nullable=0 is_null=0 */</span><br><span class="line">### SET</span><br><span class="line">###   @1=7 /* INT meta=0 nullable=0 is_null=0 */</span><br><span class="line">###   @2=&apos;user3&apos; /* VARSTRING(40) meta=40 nullable=0 is_null=0 */</span><br><span class="line">###   @3=&apos;new data3&apos; /* VARSTRING(400) meta=400 nullable=0 is_null=0 */</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div></p>
<p>主从库的数据和auto_increment值一致：<br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/E7E270E89E609A9F390088F3945A59CF.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/E7E270E89E609A9F390088F3945A59CF.jpg" alt="IMAGE" title="IMAGE"></a><br><a href="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/0181B777D2FBAEA0C106A6C8511B44FC.jpg" data-fancybox="group" data-caption="IMAGE" class="fancybox"><img src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/0181B777D2FBAEA0C106A6C8511B44FC.jpg" alt="IMAGE" title="IMAGE"></a></p>
<p>8.0的修复方法详见如下commit，对于本文讨论的问题重点关注row_upd_check_autoinc_counter()函数：<br><a href="https://github.com/mysql/mysql-server/commit/dcb8792b371601dc5fc4e9f42fb9c479532fc7c2?spm=0.11153940.blogcont60885.9.71f87fb1ijwJTI" target="_blank" rel="noopener">https://github.com/mysql/mysql-server/commit/dcb8792b371601dc5fc4e9f42fb9c479532fc7c2?spm=0.11153940.blogcont60885.9.71f87fb1ijwJTI</a></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>通过上面的分析，mysql在一开始通过引入判断last_uniq_key()来采取delete+insert或update的逻辑算是一种优化，update相对于delete+insert操作来说执行更为高效，例如锁开销更少、写入redo log中的数据更少等等。但是从该函数相关的提交历史可以看见这种优化有诸多例外情况，例如存在触发器、外键引用等，这些例外随着时间的推移不断被发现并被加入到mysql源码中。本文又叙述了另一种例外情况，同样的可以考虑将例如表中没有自增列、不是Replication Master等这些例外情况加入其中以避免文中提到的问题，也可以直接统一replace操作的行为，牺牲这种优化，避免诸多可能的bug。而在mysql8.0中update自增列的值比auto_increment值更大时将更新auto_increment，所以就没必要再考虑这种例外情况了，但在目前被广泛使用的mysql5.7中仍然存在上述问题，在使用时还需要留心。</p>
<h1 id="附："><a href="#附：" class="headerlink" title="附："></a>附：</h1><p>一些和replace相关的bug搜集：</p>
<p>Replace into causes master/slave have different auto_increment offset values<br><a href="https://bugs.mysql.com/bug.php?id=87861" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=87861</a></p>
<p>比较久远的bug，2003年被提出，直至2017年才在mysql8.0中被修复，且该bug仍存在于mysql5.7:<br>Innodb autoincrement stats los on restart<br><a href="https://bugs.mysql.com/bug.php?id=199" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=199</a><br>WL#6204: InnoDB persistent max value for autoinc columns<br><a href="https://dev.mysql.com/worklog/task/?id=6204" target="_blank" rel="noopener">https://dev.mysql.com/worklog/task/?id=6204</a></p>
<p>提到了update自增列时考虑更新auto_increment，但官方回复因存在并发、死锁相关问题且这样的场景太少，没被修复。<br>Update auto_increment column to last ID + 1 causes error on next insert<br><a href="https://bugs.mysql.com/bug.php?id=12434" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=12434</a></p>
<p>Docs for REPLACE are not accurate<br><a href="https://bugs.mysql.com/bug.php?id=54560" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=54560</a></p>
<p>Partitions: crash, REPLACE .. on table with PK, DUPLICATE KEY event<br><a href="https://bugs.mysql.com/bug.php?id=16782" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=16782</a></p>
<p>REPLACE or ON DUPLICATE KEY UPDATE in auto_increment breaks binlog<br><a href="https://bugs.mysql.com/bug.php?id=20188" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=20188</a></p>
<p>stored function inserting into two auto_increment breaks statement-based binlog<br><a href="https://bugs.mysql.com/bug.php?id=19630" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=19630</a></p>
<p>REPLACE activates UPDATE trigger, not the DELETE and INSERT triggers<br><a href="https://bugs.mysql.com/bug.php?id=13479" target="_blank" rel="noopener">https://bugs.mysql.com/bug.php?id=13479</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">wukuai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yangwuyuan.com/2019/05/10/REPLACE操作导致主从库AUTO-INCREMENT不一致的分析/">https://yangwuyuan.com/2019/05/10/REPLACE操作导致主从库AUTO-INCREMENT不一致的分析/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yangwuyuan.com">五块的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_auto_increment/324EB27B73F4CCFB76DCCD49F8D59DD2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2018/10/30/INSERT ON DUPLICATE KEY UPDATE与 REPLACE 语句简介/"><img class="next_cover lazyload" data-src="https://blog-1252157328.cos.ap-beijing.myqcloud.com/replace_intro/CA59E9D0F51582D6DEE3A47C066B56EB.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>INSERT ON DUPLICATE KEY UPDATE与 REPLACE 语句简介</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'e2h1UB0u5ErGSQbL9Imkbgbg-gzGzoHsz',
  appKey:'1Oqtp6DhWQu3wo6U1Cc9TUvA',
  placeholder:'留下你的脚步吧~',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By wukuai</div><div class="framework-info"><span>Powered by </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme by </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script></body></html>